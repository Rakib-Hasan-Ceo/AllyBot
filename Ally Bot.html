<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ally Bot Control Panel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');

        :root {
            --bg-color: #212529;
            --surface-color: #343a40;
            --primary-color: #007bff;
            --text-color: #f8f9fa;
            --text-secondary-color: #ced4da;
            --border-color: #495057;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --dynamic-text-color: #6aab9a;
            --edit-bg: #1c1f23;
            --edit-text: #f8f9fa;
            --edit-border: #495057;
            --edit-line-number: #6c757d;
            --edit-syntax-bold: #ffc107;
            --edit-syntax-placeholder: #17a2b8;
        }

        * {
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            transition: opacity 0.5s ease-in-out;
        }

        .loader {
            position: relative;
            width: 80px;
            height: 80px;
        }
        
        .loader::before, .loader::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid var(--primary-color);
            border-radius: 50%;
            opacity: 0;
            animation: wave 2s infinite ease-out;
        }

        .loader::after {
            animation-delay: 1s;
        }

        @keyframes wave {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }
            100% {
                width: 100px;
                height: 100px;
                opacity: 0;
            }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 15px;
            flex-grow: 1;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 500px;
            padding: 10px 15px;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .bot-info-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background-color: var(--surface-color);
            border-radius: 8px;
            position: relative;
        }
        
        .bot-info-display {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .bot-info-display p {
            margin: 0;
            font-size: 14px;
        }

        .bot-info-display strong {
            color: var(--primary-color);
        }
        
        .bot-status-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .bot-status {
            font-size: 14px;
            font-weight: bold;
        }

        .bot-status.online {
            color: var(--success-color);
        }

        .bot-status.offline {
            color: var(--danger-color);
        }

        #bot-power-button {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            border: 5px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-secondary-color);
            font-size: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #bot-power-button.active {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        
        #bot-power-button .status-text {
            font-size: 14px;
            margin-top: 5px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .dashboard-header h3 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .dashboard-header button {
            width: auto;
            padding: 8px 12px;
            font-size: 12px;
        }

        .dashboard-stats {
            background-color: var(--surface-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }
        
        .dashboard-stat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .dashboard-stat-item:last-child {
            border-bottom: none;
        }

        .dashboard-stat-item .label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-secondary-color);
        }

        .dashboard-stat-item i {
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        .dashboard-stat-item strong {
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
            color: var(--text-secondary-color);
        }

        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px;
            font-size: 13px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 6px;
            resize: vertical;
        }
        
        textarea {
            min-height: 80px;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        button {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: #fff;
        }

        .secondary-button {
            background-color: var(--border-color);
            color: var(--text-color);
        }

        .danger-button {
            background-color: var(--danger-color);
        }
        
        .success-button {
            background-color: var(--success-color);
        }
        
        .delete-logs-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .delete-btn-text {
            color: var(--danger-color);
            cursor: pointer;
            font-size: 14px;
            padding: 10px 15px;
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s;
        }
        
        .delete-btn-text:hover {
            background-color: var(--danger-color);
            color: white;
        }

        /* Commands Section */
        .commands-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            margin-top: 20px;
        }

        .commands-controls button {
            width: 50%;
            padding: 12px;
            font-weight: bold;
            background-color: var(--bg-color);
            color: var(--text-secondary-color);
            border: 1px solid var(--border-color);
        }
        
        .commands-controls button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .command-item {
            padding: 12px;
            background-color: var(--surface-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 8px;
        }
        
        .command-item h3 {
            margin: 0 0 4px 0;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .command-item p {
            margin: 0;
            font-size: 12px;
            color: var(--text-secondary-color);
        }

        .command-item p.dynamic-reply {
            color: var(--dynamic-text-color);
        }
        
        .command-item .command-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .command-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .placeholder-list {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .placeholder-list h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1rem;
            color: var(--primary-color);
        }
        
        .placeholder-list p {
            font-size: 14px;
            margin: 5px 0;
        }

        /* Users Section */
        .user-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
            margin-top: 20px;
        }
        
        .user-header .filter-buttons {
            display: flex;
            gap: 8px;
        }
        
        .user-header button {
            width: 50%;
            padding: 12px;
            font-weight: bold;
            background-color: var(--bg-color);
            color: var(--text-secondary-color);
            border: 1px solid var(--border-color);
        }
        
        .user-header button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .user-header p {
            margin: 0;
            font-size: 1rem;
            font-weight: bold;
        }

        .user-header input {
            flex-grow: 1;
            margin: 0;
        }

        .user-item {
            background-color: var(--surface-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 8px;
        }
        
        .user-item-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .user-item-info strong {
            color: var(--primary-color);
        }

        .user-item-info span {
            float: right;
            color: var(--text-secondary-color);
        }
        
        .user-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .user-item-actions button {
            width: 33%;
            padding: 8px;
            font-size: 12px;
        }

        /* Status Section */
        .status-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            margin-top: 20px;
        }

        .status-buttons button {
            width: 50%;
            padding: 12px;
            font-weight: bold;
            background-color: var(--bg-color);
            color: var(--text-secondary-color);
            border: 1px solid var(--border-color);
        }

        .status-buttons button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        #live-status-section h4 {
            margin-top: 0;
            color: var(--primary-color);
        }

        #live-status-section .status-log-container {
            height: 300px;
            overflow-y: auto;
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        #live-status-section p {
            margin: 5px 0;
            font-size: 14px;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .log-entry.user-sent {
            background-color: #1a2a3e;
        }
        
        .log-entry.bot-reply {
            background-color: #1a3e2a;
        }
        
        .log-entry.new-user {
            background-color: #3e2a1a;
        }

        .log-entry.error {
            background-color: #3e1a1a;
        }

        /* Errors Section */
        .error-item {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .error-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--text-secondary-color);
        }
        
        .error-item-content {
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            background-color: var(--bg-color);
            border-radius: 4-px;
            padding: 8px;
        }

        .error-item-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .error-item-buttons button {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .no-errors {
            text-align: center;
            padding: 50px 0;
            color: var(--text-secondary-color);
        }

        .no-errors .emoji {
            font-size: 4rem;
            line-height: 1;
        }

        .no-errors p {
            font-size: 1.2rem;
            margin-top: 10px;
        }

        /* Full screen edit modal */
        #edit-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--edit-bg);
            padding: 0;
        }

        #edit-modal .modal-content {
            background-color: var(--edit-bg);
            width: 100%;
            height: 100%;
            padding: 0;
            border-radius: 0;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #edit-modal .edit-top-bar {
            background-color: var(--edit-bg);
            border-bottom: 1.5px solid var(--edit-border);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #edit-modal .edit-top-bar button {
            width: auto;
            font-size: 14px;
            padding: 8px 15px;
        }

        #edit-modal .edit-top-bar .edit-button-group {
            display: flex;
            gap: 8px;
        }

        #edit-modal .edit-top-bar button.secondary-button {
            background-color: var(--edit-border);
            color: var(--edit-text);
        }
        
        #edit-modal .edit-top-bar button .fa-solid {
            font-size: 1rem;
        }
        
        #edit-modal .edit-top-bar button.secondary-button i {
            color: var(--edit-text);
        }

        #edit-modal .edit-top-bar button {
            background-color: var(--primary-color);
        }

        #edit-modal .edit-top-bar button.success-button {
            background-color: var(--success-color);
        }

        #edit-cmd {
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-bottom: 1.5px solid var(--edit-border);
            border-radius: 0;
            padding: 10px 15px;
            margin: 0;
            background-color: var(--edit-bg);
            color: var(--edit-text);
        }

        .editor-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            background-color: var(--edit-bg);
        }

        .line-numbers {
            background-color: var(--edit-bg);
            color: var(--edit-line-number);
            padding: 15px 10px 15px 15px;
            text-align: right;
            user-select: none;
            line-height: 1.6;
            overflow-y: hidden;
            font-size: 16px;
        }

        #edit-reply {
            flex-grow: 1;
            border: none;
            border-radius: 0;
            padding: 15px;
            font-size: 16px;
            line-height: 1.6;
            resize: none;
            background-color: var(--edit-bg);
            color: var(--edit-text);
            white-space: pre;
            overflow-y: auto;
            position: relative;
        }
        
        #edit-reply:focus {
            outline: none;
        }

        .placeholder-highlight {
            position: relative;
            display: inline;
        }

        .placeholder-highlight::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -2px;
            height: 1px;
            background-color: var(--primary-color);
        }

        #placeholder-display {
            background-color: var(--edit-bg);
            border-top: 1.5px solid var(--edit-border);
            padding: 10px 15px;
            min-height: 50px;
            color: var(--edit-text);
        }
        
        #placeholder-display strong {
            color: var(--primary-color);
        }

        /* Requests Section */
        .requests-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            margin-top: 20px;
        }

        .requests-controls button {
            width: 50%;
            padding: 12px;
            font-weight: bold;
            background-color: var(--bg-color);
            color: var(--text-secondary-color);
            border: 1px solid var(--border-color);
        }
        
        .requests-controls button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .request-item, .withdraw-item {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .request-item .request-text {
            font-size: 14px;
            color: var(--text-color);
            padding: 8px;
            border-radius: 4px;
            background-color: var(--bg-color);
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .request-item .request-info, .withdraw-item .withdraw-info {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .request-item .request-info strong, .withdraw-item .withdraw-info strong {
            color: var(--primary-color);
        }

        .request-item .request-buttons, .withdraw-item .withdraw-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .request-item .request-buttons button, .withdraw-item .withdraw-buttons button {
            padding: 8px 12px;
            font-size: 12px;
        }

        .button-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .button-icon .fas {
            font-size: 1rem;
        }

        .button-icon.small {
            width: 30px;
            height: 30px;
            padding: 0;
        }
        
        .delete-button-icon {
            background-color: var(--danger-color);
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .edit-button-icon, .save-button-icon {
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .edit-button-icon {
             background-color: var(--border-color);
             color: var(--text-color);
        }
        
        .save-button-icon {
             background-color: var(--primary-color);
        }
        
        .settings-section .form-group {
            background-color: var(--surface-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .token-display-group {
            display: flex;
            align-items: center;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            gap: 10px;
            word-break: break-all;
            position: relative;
        }
        
        .token-text {
            flex-grow: 1;
            font-size: 13px;
            color: var(--text-color);
            word-break: break-all;
            padding-right: 50px;
        }

        .token-buttons {
            display: flex;
            gap: 5px;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        .token-buttons .button-icon {
            background-color: var(--primary-color);
            color: #fff;
            width: 30px;
            height: 30px;
            font-size: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .autostart-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success-color);
        }

        input:checked + .slider:before {
            transform: translateX(16px);
        }

        .mail-all-btn-container {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            text-align: center;
        }

        #mail-all-btn {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            font-size: 1.2rem;
            padding: 15px 25px;
            transition: background-color 0.3s, color 0.3s;
        }
        
        #mail-all-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Menu Icon & Pop-up */
        .menu-icon {
            font-size: 24px;
            cursor: pointer;
            color: var(--primary-color);
        }

        .popup-menu {
            display: none;
            position: absolute;
            top: 50px;
            right: 10px;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 200;
            padding: 10px;
            flex-direction: column;
            gap: 8px;
        }

        .popup-menu-button {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border-radius: 6px;
            background-color: transparent;
            border: none;
            font-size: 14px;
            color: var(--text-color);
            text-align: left;
            transition: background-color 0.2s, color 0.2s;
        }
        
        .popup-menu-button:hover {
            background-color: var(--bg-color);
        }

        .popup-menu-button.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .settings-link {
            color: var(--danger-color);
            cursor: pointer;
            text-decoration: none;
            font-size: 1rem;
            display: block;
            padding: 8px 0;
            transition: color 0.2s;
        }

        .settings-link:hover {
            color: var(--text-color);
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loading-screen">
        <div class="loader"></div>
    </div>
    
    <div class="header">
        <h1>AllyBot</h1>
        <div id="menu-icon" class="menu-icon" onclick="toggleMenu()">
            <i class="fas fa-bars"></i>
        </div>
        <div id="popup-menu" class="popup-menu">
            <button id="home-btn" class="popup-menu-button active" onclick="showSection('home-section')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button id="commands-btn" class="popup-menu-button" onclick="showSection('commands-section')">
                <i class="fas fa-terminal"></i>
                <span>Commands</span>
            </button>
            <button id="users-btn" class="popup-menu-button" onclick="showSection('users-section')">
                <i class="fas fa-users"></i>
                <span>Users</span>
            </button>
            <button id="status-btn" class="popup-menu-button" onclick="showSection('status-section')">
                <i class="fas fa-chart-line"></i>
                <span>Status</span>
            </button>
            <button id="requests-btn" class="popup-menu-button" onclick="showSection('requests-section')">
                <i class="fas fa-comment-dots"></i>
                <span>Requests</span>
            </button>
             <button id="settings-btn" class="popup-menu-button" onclick="showSection('settings-section')">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </button>
        </div>
    </div>

    <div class="container">
         <div class="bot-info-header">
            <button id="bot-power-button" onclick="toggleBot()">
                <span class="fas fa-power-off"></span>
            </button>
            <div class="bot-info-display">
                <p>Bot Name: <strong id="bot-name">Hyper income 🤑</strong></p>
                <p>Bot Username: <strong id="bot-username">@Hbotfhhbot</strong></p>
                <p>Bot ID: <strong id="bot-id">8357073573</strong></p>
                <div class="bot-status-container">
                    <p id="bot-status" class="bot-status offline">Offline</p>
                    <div class="autostart-toggle-container">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autostart-toggle" onclick="toggleAutostart()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div id="home-section" class="section active">
            <div class="dashboard-stats">
                <div class="dashboard-header">
                    <h3>Bot Stats</h3>
                    <button onclick="editToken()">Add New</button>
                </div>
                <div class="dashboard-stat-item">
                    <div class="label"><i class="fas fa-users"></i>Total Users</div>
                    <strong id="total-users">0</strong>
                </div>
                <div class="dashboard-stat-item">
                    <div class="label"><i class="fas fa-paper-plane"></i>Commands Sent</div>
                    <strong id="commands-sent">0</strong>
                </div>
                <div class="dashboard-stat-item">
                    <div class="label"><i class="fas fa-ban"></i>Blocked Users</div>
                    <strong id="blocked-users">0</strong>
                </div>
                 <div class="dashboard-stat-item">
                    <div class="label"><i class="fas fa-user-slash"></i>Banned Users</div>
                    <strong id="banned-users">0</strong>
                </div>
                <div class="dashboard-stat-item">
                    <div class="label"><i class="fas fa-bug"></i>Errors Found</div>
                    <strong id="errors-found">0</strong>
                </div>
            </div>
            <div class="mail-all-btn-container">
                <button id="mail-all-btn" onclick="sendMailToAllUsers()">Send Mail to All Users</button>
            </div>
        </div>

        <div id="commands-section" class="section">
            <div class="commands-controls">
                <button id="show-commands-btn" class="active" onclick="showCommandType('commands')">Commands</button>
                <button id="show-help-btn" onclick="showCommandType('help')">Help</button>
            </div>
            <div id="commands-list">
                <div id="command-list"></div>
            </div>
            <div id="help-section" style="display:none;">
                <div id="placeholder-list" class="placeholder-list">
                    <h4>Available Placeholders:</h4>
                    <p><strong>/name/</strong>: user's first name</p>
                    <p><strong>/username/</strong>: user's username (e.g., @johndoe)</p>
                    <p><strong>/userid/</strong>: user's unique ID</p>
                    <p><strong>/refcode/</strong>: user's unique referral code</p>
                    <p><strong>/refbonus:xx/</strong>: user's unique referral code. Gives xx points to referrer</p>
                    <p><strong>/promo:promocode:bonus/</strong>: a one-time-use promo code</p>
                    <p><strong>/balance/</strong>: user's current balance</p>
                    <p><strong>/refno/</strong>: user's referral count</p>
                    <p><strong>/bot/</strong>: your bot's name</p>
                    <p><strong>/imageurl:URL/</strong>: sends an image from the provided URL</p>
                    <p><strong>/inlinebtn:Text:URL/</strong>: adds an inline button with a link</p>
                    <p><strong>/commandbtn:btnname:commandname/</strong>: adds an inline button that sends a command</p>
                    <p><strong>/getrequest/</strong>: asks for a user's reply for a request</p>
                    <p><strong>/getwithdrawno/</strong>: asks for a user's withdrawal amount</p>
                    <p><strong>/sendreply:CHAT_ID/</strong>: sends a reply to a specific user or chat</p>
                    <p><strong>/cancelbtn/</strong>: adds an inline button to cancel and return to a main menu command</p>
                    <p><strong>/autodelete/</strong>: deletes previous bot messages</p>
                    <p><strong>*text*</strong>: wraps text in bold</p>
                    <p><strong>_text_</strong>: wraps text in italic</p>
                    <p><strong>`text`</strong>: wraps text in monospace code font</p>
                    <p><strong>"text"</strong>: wraps text in a quote</p>
                </div>
            </div>
        </div>

        <div id="users-section" class="section">
            <div class="user-header">
                <div class="filter-buttons">
                    <button id="show-all-users-btn" class="active" onclick="showUserType('all')">All Users</button>
                    <button id="show-banned-users-btn" onclick="showUserType('banned')">Banned</button>
                </div>
                <input type="text" id="user-search" placeholder="Search users...">
            </div>
            <div id="user-list"></div>
        </div>
        
        <div id="status-section" class="section">
            <div class="status-buttons">
                <button id="live-status-btn" class="active" onclick="showStatusType('live')">Live Status</button>
                <button id="errors-btn" onclick="showStatusType('errors')">Errors</button>
            </div>
            <div id="live-status-section">
                <h4>Live Feed</h4>
                <div id="live-log" class="status-log-container"></div>
            </div>
            <div id="errors-section" style="display:none;">
                <div id="error-log"></div>
            </div>
        </div>

        <div id="requests-section" class="section">
            <div class="requests-controls">
                <button id="user-messages-btn" class="active" onclick="showRequestType('messages')">User Messages</button>
                <button id="withdrawal-requests-btn" onclick="showRequestType('withdrawals')">Withdrawal Requests</button>
            </div>
            <div id="request-list"></div>
            <div id="withdraw-list" style="display:none;"></div>
        </div>

        <div id="settings-section" class="section">
            <div class="settings-section">
                <h3>Bot Token</h3>
                <div class="token-display-group">
                    <span id="token-text" class="token-text">******************************************</span>
                    <div class="token-buttons">
                        <button class="button-icon" onclick="editToken()">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="button-icon" onclick="deleteToken()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Delete All Data</h3>
                <a class="settings-link" onclick="clearAllData()">Delete All Data</a>
            </div>

        </div>

    </div>
    
    <div id="edit-modal">
        <div class="modal-content">
            <div class="edit-top-bar">
                <button class="secondary-button" onclick="closeEditModal()"><i class="fas fa-times"></i></button>
                <div class="edit-button-group">
                    <button class="secondary-button" onclick="undoEdit()"><i class="fas fa-undo"></i></button>
                    <button class="secondary-button" onclick="redoEdit()"><i class="fas fa-redo"></i></button>
                    <button class="success-button" onclick="copyReply()"><i class="fas fa-copy"></i></button>
                    <button onclick="saveEditedCommand()"><i class="fas fa-save"></i></button>
                </div>
            </div>
            <input type="text" id="edit-cmd" placeholder="Command (e.g., start)">
            <div class="editor-container">
                <div class="line-numbers"></div>
                <textarea id="edit-reply" placeholder="Write your reply here..."></textarea>
            </div>
            <div id="placeholder-display"></div>
        </div>
    </div>

    <script>
        let running = false;
        let offset = 0;
        let token = '';
        let botInfo = {
            id: '8357073573',
            name: 'Hyper income 🤑',
            username: '@Hbotfhhbot',
        };
        let commandMap = {};
        let userData = {};
        let promoCodes = {};
        let errorLog = [];
        let requestsLog = [];
        let withdrawLog = [];
        let liveLog = [];
        let currentCommandToEdit = null;
        let messageHistory = {};
        let commandsUsed = 0;
        let blockedUsers = {};
        let undoStack = [];
        let redoStack = [];
        let currentRequestType = 'messages';
        let currentUserType = 'all';
        let currentCommandType = 'commands';

        const PLACEHOLDERS = [
            { text: '/name/', description: 'user\'s first name' },
            { text: '/username/', description: 'user\'s username (e.g., @johndoe)' },
            { text: '/userid/', description: 'user\'s unique ID' },
            { text: '/refcode/', description: 'user\'s unique referral code' },
            { text: '/refbonus:xx/', description: 'user\'s unique referral code. Gives xx points to referrer' },
            { text: '/promo:promocode:bonus/', description: 'a one-time-use promo code' },
            { text: '/balance/', description: 'user\'s current balance' },
            { text: '/refno/', description: 'user\'s referral count' },
            { text: '/bot/', description: 'your bot' },
            { text: '/imageurl:URL/', description: 'sends an image from the provided URL' },
            { text: '/inlinebtn:Text:URL/', description: 'adds an inline button with a link' },
            { text: '/commandbtn:btnname:commandname/', description: 'adds an inline button that sends a command' },
            { text: '/getrequest/', description: 'asks for a user\'s reply for a request' },
            { text: '/getwithdrawno/', description: 'asks for a user\'s withdrawal amount' },
            { text: '/sendreply:CHAT_ID/', description: 'sends a reply to a specific user or chat' },
            { text: '/cancelbtn/', description: 'adds an inline button to cancel and return to a main menu command' },
            { text: '/autodelete/', description: 'deletes previous bot messages' },
            { text: '*text*', description: 'wraps text in bold' },
            { text: '_text_', description: 'wraps text in italic' },
            { text: '`text`', description: 'wraps text in monospace code font' },
            { text: '"text"', description: 'wraps text in a quote' }
        ];
        
        const REFERRAL_CODE_LENGTH = 8;
        const BAN_MESSAGE = '<b>Sorry you are banned ❌\nConnect with admin or creator ⚠️</b>';

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.popup-menu-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(sectionId.replace('-section', '-btn')).classList.add('active');
            document.getElementById('popup-menu').style.display = 'none';

            if (sectionId === 'users-section') {
                showUserType(currentUserType);
            } else if (sectionId === 'commands-section') {
                showCommandType(currentCommandType);
            } else if (sectionId === 'status-section') {
                showStatusType('live');
            } else if (sectionId === 'requests-section') {
                showRequestType(currentRequestType);
            } else if (sectionId === 'home-section') {
                updateDashboardStats();
            }
        }
        
        function toggleMenu() {
            const menu = document.getElementById('popup-menu');
            if (menu.style.display === 'flex') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'flex';
            }
        }

        function showStatusType(type) {
            const liveBtn = document.getElementById('live-status-btn');
            const errorsBtn = document.getElementById('errors-btn');
            const liveSection = document.getElementById('live-status-section');
            const errorsSection = document.getElementById('errors-section');
            
            if (type === 'live') {
                liveBtn.classList.add('active');
                errorsBtn.classList.remove('active');
                liveSection.style.display = 'block';
                errorsSection.style.display = 'none';
                renderLiveLog();
            } else {
                errorsBtn.classList.add('active');
                liveBtn.classList.remove('active');
                liveSection.style.display = 'none';
                errorsSection.style.display = 'block';
                renderErrorLog();
            }
        }
        
        function showCommandType(type) {
            currentCommandType = type;
            const commandsBtn = document.getElementById('show-commands-btn');
            const helpBtn = document.getElementById('show-help-btn');
            const commandsList = document.getElementById('commands-list');
            const helpSection = document.getElementById('help-section');
            
            if (type === 'commands') {
                commandsBtn.classList.add('active');
                helpBtn.classList.remove('active');
                commandsList.style.display = 'block';
                helpSection.style.display = 'none';
                renderCommands();
            } else {
                helpBtn.classList.add('active');
                commandsBtn.classList.remove('active');
                commandsList.style.display = 'none';
                helpSection.style.display = 'block';
            }
        }

        function showRequestType(type) {
            currentRequestType = type;
            const msgBtn = document.getElementById('user-messages-btn');
            const withdrawBtn = document.getElementById('withdrawal-requests-btn');
            const reqList = document.getElementById('request-list');
            const withdrawList = document.getElementById('withdraw-list');
            
            if (type === 'messages') {
                msgBtn.classList.add('active');
                withdrawBtn.classList.remove('active');
                reqList.style.display = 'block';
                withdrawList.style.display = 'none';
                renderRequests();
            } else {
                withdrawBtn.classList.add('active');
                msgBtn.classList.remove('active');
                reqList.style.display = 'none';
                withdrawList.style.display = 'block';
                renderWithdrawals();
            }
        }


        function loadFromLocalStorage() {
            const savedToken = localStorage.getItem('telegramBotToken');
            const savedCommands = localStorage.getItem('telegramBotCommands');
            const savedUserData = localStorage.getItem('telegramUserData');
            const savedPromoCodes = localStorage.getItem('telegramPromoCodes');
            const savedErrorLog = localStorage.getItem('telegramErrorLog');
            const savedRequests = localStorage.getItem('telegramRequests');
            const savedWithdrawals = localStorage.getItem('telegramWithdrawals');
            const savedLiveLog = localStorage.getItem('telegramLiveLog');
            const savedCommandsUsed = localStorage.getItem('commandsUsed');
            const savedBlockedUsers = localStorage.getItem('blockedUsers');
            const autostartEnabled = localStorage.getItem('autostartEnabled') === 'true';

            if (savedToken) {
                document.getElementById('token-text').innerText = '******************************************';
                token = savedToken;
                fetchBotInfo(token);
            }
            if (savedCommands) {
                commandMap = JSON.parse(savedCommands);
            }
            if (savedUserData) {
                userData = JSON.parse(savedUserData);
            }
            if (savedPromoCodes) {
                promoCodes = JSON.parse(savedPromoCodes);
            }
            if (savedErrorLog) {
                errorLog = JSON.parse(savedErrorLog);
            }
            if (savedRequests) {
                requestsLog = JSON.parse(savedRequests);
            }
            if (savedWithdrawals) {
                withdrawLog = JSON.parse(savedWithdrawals);
            }
            if (savedLiveLog) {
                liveLog = JSON.parse(savedLiveLog);
            }
            if (savedCommandsUsed) {
                commandsUsed = parseInt(savedCommandsUsed, 10);
            }
            if (savedBlockedUsers) {
                blockedUsers = JSON.parse(savedBlockedUsers);
            }
            if (autostartEnabled) {
                document.getElementById('autostart-toggle').checked = true;
                startBot();
            }
            updateDashboardStats();
        }

        async function fetchBotInfo(token) {
            try {
                const res = await fetch(`https://api.telegram.org/bot${token}/getMe`);
                const data = await res.json();
                if (data.ok) {
                    botInfo.id = data.result.id;
                    botInfo.name = data.result.first_name;
                    botInfo.username = data.result.username;
                    updateBotStatusDisplay();
                } else {
                    logError(`Http error: ${data.description}`);
                }
            } catch (e) {
                logError(`Error fetching bot info: ${e.message}`);
            }
        }

        function updateBotStatusDisplay() {
            document.getElementById('bot-name').innerText = botInfo.name;
            document.getElementById('bot-username').innerText = botInfo.username ? `@${botInfo.username}` : 'N/A';
            document.getElementById('bot-id').innerText = botInfo.id;
            
            const botStatus = document.getElementById('bot-status');
            const powerBtn = document.getElementById('bot-power-button');
            if (running) {
                botStatus.innerText = 'Online';
                botStatus.classList.remove('offline');
                botStatus.classList.add('online');
                powerBtn.classList.add('active');
            } else {
                botStatus.innerText = 'Offline';
                botStatus.classList.remove('online');
                botStatus.classList.add('offline');
                powerBtn.classList.remove('active');
            }
        }

        function updateDashboardStats() {
            const bannedCount = Object.values(userData).filter(user => user.isBanned).length;
            document.getElementById('total-users').innerText = Object.keys(userData).length;
            document.getElementById('commands-sent').innerText = commandsUsed;
            document.getElementById('errors-found').innerText = errorLog.length;
            document.getElementById('blocked-users').innerText = Object.keys(blockedUsers).length;
            document.getElementById('banned-users').innerText = bannedCount;
        }
        
        function saveToLocalStorage() {
            localStorage.setItem('telegramBotCommands', JSON.stringify(commandMap));
            localStorage.setItem('telegramUserData', JSON.stringify(userData));
            localStorage.setItem('telegramPromoCodes', JSON.stringify(promoCodes));
            localStorage.setItem('telegramErrorLog', JSON.stringify(errorLog));
            localStorage.setItem('telegramRequests', JSON.stringify(requestsLog));
            localStorage.setItem('telegramWithdrawals', JSON.stringify(withdrawLog));
            localStorage.setItem('telegramLiveLog', JSON.stringify(liveLog));
            localStorage.setItem('commandsUsed', commandsUsed);
            localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
            updateDashboardStats();
        }

        function renderCommands() {
            const container = document.getElementById('command-list');
            container.innerHTML = '';
            for (const cmd in commandMap) {
                if (commandMap.hasOwnProperty(cmd)) {
                    createCommandItem(cmd, commandMap[cmd]);
                }
            }
        }
        
        function showUserType(type) {
            currentUserType = type;
            const allUsersBtn = document.getElementById('show-all-users-btn');
            const bannedUsersBtn = document.getElementById('show-banned-users-btn');
            
            if (type === 'all') {
                allUsersBtn.classList.add('active');
                bannedUsersBtn.classList.remove('active');
            } else {
                allUsersBtn.classList.remove('active');
                bannedUsersBtn.classList.add('active');
            }
            renderUserList(document.getElementById('user-search').value);
        }

        function renderUserList(searchTerm = '') {
            const userListDiv = document.getElementById('user-list');
            userListDiv.innerHTML = '';
            
            let filteredUsers = Object.keys(userData);
            
            if (currentUserType === 'banned') {
                filteredUsers = filteredUsers.filter(id => userData[id].isBanned);
            }

            filteredUsers = filteredUsers.filter(id => {
                const user = userData[id];
                const searchLower = searchTerm.toLowerCase();
                return (user.name && user.name.toLowerCase().includes(searchLower)) ||
                       (user.username && user.username.toLowerCase().includes(searchLower));
            });

            if (filteredUsers.length === 0 && searchTerm) {
                userListDiv.innerHTML = `<p style="text-align:center;color:var(--text-secondary-color);">No users found for "${searchTerm}"</p>`;
                return;
            }

            for (const id of filteredUsers) {
                const user = userData[id];
                const userItem = document.createElement('div');
                userItem.className = 'user-item';

                let userInfoHtml = `
                    <div class="user-item-info">
                        <p><strong>Name:</strong> ${user.name || 'N/A'}</p>
                        <p><strong>Username:</strong> ${user.username ? `@${user.username}` : 'N/A'}</p>
                    </div>
                `;
                
                if (user.balance !== undefined && user.refCount !== undefined) {
                    userInfoHtml += `<p><strong>Balance:</strong> ${user.balance || 0}<span><strong>Refar:</strong> ${user.refCount || 0}</span></p>`;
                } else if (user.balance !== undefined) {
                     userInfoHtml += `<p><strong>Balance:</strong> ${user.balance || 0}</p>`;
                } else if (user.refCount !== undefined) {
                     userInfoHtml += `<p><span><strong>Refar:</strong> ${user.refCount || 0}</span></p>`;
                }

                userItem.innerHTML = `
                    <div class="user-item-info">
                        ${userInfoHtml}
                    </div>
                    <div class="user-item-actions">
                        <button onclick="toggleBan('${id}')" class="${user.isBanned ? 'danger-button' : 'secondary-button'}">${user.isBanned ? 'Unban' : 'Ban'}</button>
                        <button onclick="sendMailAlert('${id}')" class="secondary-button">Mail</button>
                        <button onclick="editBalance('${id}')">Edit Balance</button>
                    </div>
                `;

                userListDiv.appendChild(userItem);
            }
        }

        function renderRequests() {
            const requestListDiv = document.getElementById('request-list');
            requestListDiv.innerHTML = '<h4>User Messages</h4>';
            if (requestsLog.length === 0) {
                requestListDiv.innerHTML += `<p style="text-align:center;color:var(--text-secondary-color);">No user messages found.</p>`;
                return;
            }
            requestsLog.forEach((req, index) => {
                const user = userData[req.userId] || { name: 'Unknown', username: 'N/A' };
                const requestItem = document.createElement('div');
                requestItem.className = 'request-item';
                requestItem.innerHTML = `
                    <div class="request-info">
                        <strong>Message from @${user.username}</strong>
                    </div>
                    <div class="request-text">
                        ${req.message}
                    </div>
                    <div class="request-buttons">
                        <button class="secondary-button" onclick="sendMailAlert('${req.userId}')">Mail</button>
                        <button class="danger-button" onclick="toggleBan('${req.userId}')">Ban</button>
                        <button class="secondary-button" onclick="deleteRequest(${index})">Delete</button>
                    </div>
                `;
                requestListDiv.appendChild(requestItem);
            });
        }
        
        function renderWithdrawals() {
            const withdrawListDiv = document.getElementById('withdraw-list');
            withdrawListDiv.innerHTML = '<h4>Withdrawal Requests</h4>';
             if (withdrawLog.length === 0) {
                withdrawListDiv.innerHTML += `<p style="text-align:center;color:var(--text-secondary-color);">No withdrawal requests found.</p>`;
                return;
            }
            withdrawLog.forEach((req, index) => {
                const user = userData[req.userId] || { name: 'Unknown', username: 'N/A' };
                const withdrawItem = document.createElement('div');
                withdrawItem.className = 'withdraw-item';
                withdrawItem.innerHTML = `
                    <div class="withdraw-info">
                        <p>Withdrawal request from <strong>${user.name}</strong> (@${user.username})</p>
                        <p><strong>Amount:</strong> ${req.amount}</p>
                        <p><strong>Refar:</strong> ${user.refCount || 0}</p>
                    </div>
                    <div class="withdraw-buttons">
                        <button class="success-button" onclick="acceptWithdraw('${index}')">Accept</button>
                        <button class="danger-button" onclick="rejectWithdraw('${index}')">Reject</button>
                        <button class="secondary-button" onclick="sendMailAlert('${req.userId}')">Mail</button>
                        <button class="danger-button" onclick="toggleBan('${req.userId}')">Ban</button>
                    </div>
                `;
                withdrawListDiv.appendChild(withdrawItem);
            });
        }

        async function acceptWithdraw(index) {
            const req = withdrawLog[index];
            if (confirm(`Accept withdrawal request of ${req.amount} from @${userData[req.userId].username}?`)) {
                if(userData[req.userId].balance >= req.amount) {
                    userData[req.userId].balance -= req.amount;
                    await sendMessage(req.userId, `Your withdrawal request of ${req.amount} has been accepted.`);
                    withdrawLog.splice(index, 1);
                    saveToLocalStorage();
                    renderWithdrawals();
                } else {
                     alert('User does not have enough balance for this withdrawal.');
                }
            }
        }

        function rejectWithdraw(index) {
            const req = withdrawLog[index];
            if (confirm(`Reject withdrawal request of ${req.amount} from @${userData[req.userId].username}?`)) {
                sendMailAlert(req.userId, `Your withdrawal request of ${req.amount} has been rejected.`);
                withdrawLog.splice(index, 1);
                saveToLocalStorage();
                renderWithdrawals();
            }
        }

        function deleteRequest(index) {
            if (confirm('Are you sure you want to delete this request?')) {
                requestsLog.splice(index, 1);
                saveToLocalStorage();
                renderRequests();
            }
        }

        function toggleBan(userId) {
            userData[userId].isBanned = !userData[userId].isBanned;
            saveToLocalStorage();
            renderUserList(document.getElementById('user-search').value);
            renderRequests();
            renderWithdrawals();
        }
        
        async function sendMailToAllUsers() {
            const mailMessage = prompt("Enter message to send to all users:");
            if (mailMessage) {
                for (const userId in userData) {
                    if (userData.hasOwnProperty(userId)) {
                        await sendMessage(userId, mailMessage);
                    }
                }
                alert('Mail sent to all users!');
            }
        }

        async function sendMailAlert(userId, message = '') {
            const user = userData[userId];
            const mailMessage = prompt(`Enter message for @${user.username || user.name}:`, message);
            if (mailMessage) {
                await sendMessage(userId, mailMessage);
                alert('Message sent successfully!');
            }
        }

        function editBalance(userId) {
            const newBalance = prompt(`Enter new balance for user ${userId}:`);
            if (newBalance !== null && !isNaN(newBalance)) {
                userData[userId].balance = parseFloat(newBalance);
                saveToLocalStorage();
                renderUserList(document.getElementById('user-search').value);
            } else if (newBalance !== null) {
                alert('Invalid number entered for balance.');
            }
        }

        function renderErrorLog() {
            const errorLogDiv = document.getElementById('error-log');
            errorLogDiv.innerHTML = '';
            if (errorLog.length === 0) {
                errorLogDiv.innerHTML = `
                    <div class="no-errors">
                        <div class="emoji">🐞</div>
                        <p>No errors found</p>
                    </div>
                `;
            } else {
                errorLog.forEach((error, index) => {
                    const errorItem = document.createElement('div');
                    errorItem.className = 'error-item';
                    errorItem.setAttribute('data-index', index);
                    errorItem.innerHTML = `
                        <div class="error-item-header">
                            <span>[${error.time}]</span>
                        </div>
                        <div class="error-item-content">${error.message}</div>
                        <div class="error-item-buttons">
                            <button class="secondary-button" onclick="copyError(${index})">Copy</button>
                            <button class="danger-button" onclick="deleteError(${index})">Delete</button>
                        </div>
                    `;
                    errorLogDiv.appendChild(errorItem);
                });
            }
        }
        
        function renderLiveLog() {
            const liveLogDiv = document.getElementById('live-log');
            liveLogDiv.innerHTML = '';
            liveLog.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = `log-entry ${log.type}`;
                logItem.innerHTML = `<strong>[${log.time}]</strong> ${log.message}`;
                liveLogDiv.appendChild(logItem);
            });
            liveLogDiv.scrollTop = liveLogDiv.scrollHeight;
        }

        function logLive(type, message) {
            liveLog.push({ type, message, time: new Date().toLocaleTimeString() });
            if (liveLog.length > 50) {
                liveLog.shift();
            }
            saveToLocalStorage();
            if (document.getElementById('live-status-btn').classList.contains('active')) {
                renderLiveLog();
            }
        }

        function copyError(index) {
            const errorText = errorLog[index].message;
            navigator.clipboard.writeText(errorText).then(() => {
                alert('Error copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }

        function deleteError(index) {
            errorLog.splice(index, 1);
            saveToLocalStorage();
            renderErrorLog();
        }

        function hasPlaceholder(text) {
            return PLACEHOLDERS.some(p => text.includes(p.text));
        }

        function createCommandItem(cmd, reply) {
            const container = document.getElementById('command-list');
            const item = document.createElement('div');
            item.className = 'command-item';

            const cmdDisplay = document.createElement('h3');
            cmdDisplay.textContent = cmd;

            const replyDisplay = document.createElement('p');
            replyDisplay.textContent = reply.length > 50 ? reply.substring(0, 50) + '...' : reply;
            if (hasPlaceholder(reply)) {
                replyDisplay.classList.add('dynamic-reply');
            }

            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'command-buttons';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'edit-button-icon small';
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.onclick = () => openEditModal(cmd, reply);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-button-icon small';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.onclick = () => deleteCommand(cmd);

            buttonsDiv.appendChild(editBtn);
            buttonsDiv.appendChild(deleteBtn);
            
            item.appendChild(cmdDisplay);
            item.appendChild(replyDisplay);
            item.appendChild(buttonsDiv);
            container.appendChild(item);
        }
        
        function openEditModal(cmd, reply) {
            currentCommandToEdit = cmd;
            document.getElementById('edit-cmd').value = cmd;
            document.getElementById('edit-reply').value = reply;
            undoStack = [reply];
            redoStack = [];
            updateLineNumbers();
            updatePlaceholderDisplay();
            document.getElementById('edit-modal').style.display = 'block';
        }

        function undoEdit() {
            if (undoStack.length > 1) {
                const lastState = undoStack.pop();
                redoStack.push(lastState);
                const previousState = undoStack[undoStack.length - 1];
                document.getElementById('edit-reply').value = previousState;
                updateLineNumbers();
                updatePlaceholderDisplay();
            }
        }

        function redoEdit() {
            if (redoStack.length > 0) {
                const nextState = redoStack.pop();
                undoStack.push(nextState);
                document.getElementById('edit-reply').value = nextState;
                updateLineNumbers();
                updatePlaceholderDisplay();
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }
        
        function saveEditedCommand() {
            const newCmd = document.getElementById('edit-cmd').value.trim();
            const newReply = document.getElementById('edit-reply').value.trim();

            if (newCmd && newReply) {
                delete commandMap[currentCommandToEdit];
                commandMap[newCmd] = newReply;
                saveToLocalStorage();
                closeEditModal();
                showSection('commands-section');
            } else {
                alert('Command and reply text cannot be empty.');
            }
        }

        function copyReply() {
            const replyText = document.getElementById('edit-reply').value;
            navigator.clipboard.writeText(replyText).then(() => {
                alert('Reply text copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }

        function addCommand() {
            const newCmd = prompt('Enter the new command (e.g., start):');
            if (newCmd) {
                const newReply = prompt('Enter the reply text for this command:');
                if (newReply) {
                    commandMap[newCmd] = newReply;
                    saveToLocalStorage();
                    showSection('commands-section');
                }
            }
        }

        function deleteCommand(cmd) {
            if (confirm(`Are you sure you want to delete the command "${cmd}"?`)) {
                delete commandMap[cmd];
                saveToLocalStorage();
                showSection('commands-section');
            }
        }
        
        function editToken() {
            const currentToken = localStorage.getItem('telegramBotToken');
            const newToken = prompt('Enter the new Telegram Bot Token:', currentToken || '');
            if (newToken !== null) {
                token = newToken.trim();
                if (token) {
                    localStorage.setItem('telegramBotToken', token);
                    document.getElementById('token-text').innerText = '******************************************';
                    fetchBotInfo(token);
                    alert('Bot token updated successfully!');
                } else {
                    deleteToken();
                }
            }
        }

        function deleteToken() {
            if (confirm('Are you sure you want to delete the bot token?')) {
                token = '';
                localStorage.removeItem('telegramBotToken');
                document.getElementById('token-text').innerText = 'No token set';
                alert('Bot token has been deleted.');
            }
        }

        function toggleAutostart() {
            const autostartToggle = document.getElementById('autostart-toggle');
            localStorage.setItem('autostartEnabled', autostartToggle.checked);
        }
        
        function toggleBot() {
            if (running) {
                stopBot();
            } else {
                startBot();
            }
        }

        function startBot() {
            token = localStorage.getItem('telegramBotToken');
            if (!token) {
                alert('Please add a bot token first.');
                return;
            }

            running = true;
            updateBotStatusDisplay();
            poll();
        }

        function stopBot() {
            running = false;
            updateBotStatusDisplay();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete all bot data? This cannot be undone.')) {
                localStorage.clear();
                window.location.reload();
            }
        }

        function generateRefCode() {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const charactersLength = characters.length;
            for (let i = 0; i < REFERRAL_CODE_LENGTH; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }
        
        function formatMarkdown(text) {
            let formattedText = text;
            formattedText = formattedText.replace(/\*(.*?)\*/g, '<b>$1</b>');
            formattedText = formattedText.replace(/`(.*?)`/g, '<code>$1</code>');
            formattedText = formattedText.replace(/_(.*?)_/g, '<i>$1</i>');
            formattedText = formattedText.replace(/"(.*?)"/g, '<blockquote>$1</blockquote>');
            return formattedText;
        }
        
        function parseReply(text, message) {
            if (!message) return { text, keyboard: null, sendReplyToId: null, imageUrl: null, expectingReplyTo: null, autoDelete: false, refBonus: 0 };
            const user = message.from;
            const chatId = message.chat.id;
            let parsedText = text;
            let keyboard = null;
            let imageUrl = null;
            let buttons = [];
            let commandButtons = [];
            let expectingReply = false;
            let expectingWithdrawal = false;
            let expectingReplyTo = null;
            let autoDelete = false;
            let refBonus = 0;

            if (user) {
                const fullName = (user.first_name || '') + (user.last_name ? ' ' + user.last_name : '');
                parsedText = parsedText.replace(/\/name\//g, fullName.trim() || 'N/A');
                parsedText = parsedText.replace(/\/username\//g, user.username ? `@${user.username}` : 'N/A');
                parsedText = parsedText.replace(/\/userid\//g, user.id || 'N/A');
            }
            
            if (botInfo.name) {
                parsedText = parsedText.replace(/\/bot\//g, botInfo.name);
            }

            if (!userData[chatId]) {
                logLive('new-user', `New user joined: @${user.username || user.first_name} (${chatId})`);
                userData[chatId] = {
                    name: user.first_name,
                    username: user.username,
                    isBanned: false,
                    expectingReply: false,
                    expectingWithdrawal: false,
                    expectingReplyTo: null,
                    autodelete: false,
                    refCount: 0,
                    balance: 0,
                    referredBy: null,
                    promosUsed: []
                };
            }
            
            if (text.includes('/refcode/')) {
                if (!userData[chatId].refCode) {
                    userData[chatId].refCode = generateRefCode();
                }
                parsedText = parsedText.replace(/\/refcode\//g, userData[chatId].refCode);
            }
            
            const refBonusMatch = text.match(/\/refbonus:(\d+)\//);
            if (refBonusMatch) {
                refBonus = parseInt(refBonusMatch[1], 10);
                if (!userData[chatId].refCode) {
                    userData[chatId].refCode = generateRefCode();
                }
                parsedText = parsedText.replace(/\/refbonus:(\d+)\//g, userData[chatId].refCode);
            }
            
            if (text.includes('/refno/')) {
                const refCount = userData[chatId].refCount || 0;
                parsedText = parsedText.replace(/\/refno\//g, refCount);
            }
            
            if (text.includes('/balance/')) {
                const balance = userData[chatId].balance || 0;
                parsedText = parsedText.replace(/\/balance\//g, balance);
            }

            const promoRegex = /\/promo:([^:]+):(\d+)\//;
            const promoMatch = parsedText.match(promoRegex);
            if (promoMatch) {
                const promoCode = promoMatch[1].trim();
                const bonus = parseInt(promoMatch[2], 10);
                promoCodes[promoCode] = { bonus: bonus, usedBy: [] };
                parsedText = parsedText.replace(promoRegex, 'Promo code created!');
            }

            const imageUrlRegex = /\/imageurl:([^\s]+)\//;
            const imageUrlMatch = parsedText.match(imageUrlRegex);
            if (imageUrlMatch) {
                imageUrl = imageUrlMatch[1];
                parsedText = parsedText.replace(imageUrlRegex, '').trim();
            }

            const inlineBtnRegex = /\/inlinebtn:([^:]+):(.+?)(?=\/inlinebtn:|$|\n)/g;
            let inlineMatch;
            let currentRow = [];
            while ((inlineMatch = inlineBtnRegex.exec(parsedText)) !== null) {
                const buttonData = { text: inlineMatch[1], url: inlineMatch[2].trim() };
                currentRow.push(buttonData);
            }
            if (currentRow.length > 0) {
                buttons.push(currentRow);
            }
            parsedText = parsedText.replace(inlineBtnRegex, '');
            
            const commandBtnRegex = /\/commandbtn:([^:]+):(.+?)\//g;
            let commandMatch;
            currentRow = [];
            while ((commandMatch = commandBtnRegex.exec(parsedText)) !== null) {
                const buttonText = commandMatch[1].trim();
                const cmd = commandMatch[2].trim();
                currentRow.push({ text: buttonText, callback_data: cmd });
            }
            if (currentRow.length > 0) {
                commandButtons.push(currentRow);
            }
            parsedText = parsedText.replace(commandBtnRegex, '');

            if (parsedText.includes('/cancelbtn/')) {
                 const cancelBtn = { text: '❌ Cancel', callback_data: 'start' };
                 commandButtons.push([cancelBtn]);
                 parsedText = parsedText.replace(/\/cancelbtn\//g, '').trim();
            }

            if (parsedText.includes('/autodelete/')) {
                autoDelete = true;
                parsedText = parsedText.replace(/\/autodelete\//g, '').trim();
            }
            
            const getReplyRegex = /\/getrequest\/|\/sendreply:(-?\d+)\//;
            const getReplyMatch = parsedText.match(getReplyRegex);
            if (getReplyMatch) {
                if (getReplyMatch[0] === '/getrequest/') {
                     expectingReply = true;
                } else if (getReplyMatch[1]) {
                    expectingReplyTo = getReplyMatch[1];
                }
                parsedText = parsedText.replace(getReplyRegex, '').trim();
            }

            if (parsedText.includes('/getwithdrawno/')) {
                expectingWithdrawal = true;
                parsedText = parsedText.replace(/\/getwithdrawno\//g, '').trim();
            }
            
            userData[chatId].expectingReply = expectingReply;
            userData[chatId].expectingWithdrawal = expectingWithdrawal;
            userData[chatId].expectingReplyTo = expectingReplyTo;
            userData[chatId].autodelete = autoDelete;

            let replyMarkup = {};
            if (buttons.length > 0 || commandButtons.length > 0) {
                replyMarkup = {
                    inline_keyboard: buttons.concat(commandButtons),
                };
            }
            
            saveToLocalStorage();
            const formattedText = formatMarkdown(parsedText);
            return { text: formattedText.trim(), keyboard: replyMarkup, imageUrl, autoDelete, refBonus };
        }

        async function poll() {
            if (!running) {
                setTimeout(startBot, 2000); 
                return;
            }

            try {
                const res = await fetch(`https://api.telegram.org/bot${token}/getUpdates?offset=${offset}&timeout=30`);
                const data = await res.json();
                if (data.ok) {
                    for (const update of data.result) {
                        offset = update.update_id + 1;
                        
                        let text, chatId, user, messageId;

                        if (update.message) {
                            text = update.message.text ? update.message.text.trim() : '';
                            chatId = update.message.chat.id;
                            user = update.message.from;
                            messageId = update.message.message_id;
                        } else if (update.callback_query) {
                            text = update.callback_query.data;
                            chatId = update.callback_query.message.chat.id;
                            user = update.callback_query.from;
                            messageId = update.callback_query.message.message_id;
                        } else {
                            continue;
                        }

                        if (!userData[chatId]) {
                            userData[chatId] = {
                                name: user.first_name,
                                username: user.username,
                                isBanned: false,
                                expectingReply: false,
                                expectingWithdrawal: false,
                                expectingReplyTo: null,
                                autodelete: false,
                                refCount: 0,
                                balance: 0,
                                referredBy: null,
                                promosUsed: []
                            };
                            saveToLocalStorage();
                        }

                        if (userData[chatId].isBanned) {
                            await sendMessage(chatId, BAN_MESSAGE, null, 'HTML');
                            continue;
                        }

                        logLive('user-sent', `User @${user.username || user.first_name} sent: "${text}"`);

                        const expectingReply = userData[chatId].expectingReply;
                        const expectingWithdrawal = userData[chatId].expectingWithdrawal;
                        const expectingReplyTo = userData[chatId].expectingReplyTo;

                        // Handle replies to pending requests
                        if (expectingReply && commandMap[text] === undefined) {
                            requestsLog.unshift({
                                userId: chatId,
                                message: text,
                                time: new Date().toLocaleTimeString(),
                            });
                            userData[chatId].expectingReply = false;
                            saveToLocalStorage();
                            await sendMessage(chatId, 'Thank you for your response! We have received your request.');
                            continue;
                        }

                        if (expectingReplyTo && commandMap[text] === undefined) {
                            const forwardChatId = expectingReplyTo;
                            const forwardedMessage = `*New reply from* @${user.username || user.first_name} (${chatId}):\n\n${text}`;
                            await sendMessage(forwardChatId, forwardedMessage, null, 'Markdown');
                            userData[chatId].expectingReplyTo = null;
                            saveToLocalStorage();
                            await sendMessage(chatId, 'Your message has been sent!');
                            continue;
                        }
                        
                        if (expectingWithdrawal && commandMap[text] === undefined) {
                            const withdrawalAmount = parseFloat(text);
                            if (!isNaN(withdrawalAmount) && userData[chatId].balance >= withdrawalAmount && withdrawalAmount > 0) {
                                withdrawLog.unshift({
                                    userId: chatId,
                                    amount: withdrawalAmount,
                                    time: new Date().toLocaleTimeString(),
                                });
                                userData[chatId].expectingWithdrawal = false;
                                saveToLocalStorage();
                                await sendMessage(chatId, `Your withdrawal request for ${withdrawalAmount} has been received.`);
                            } else if (withdrawalAmount <= 0) {
                                await sendMessage(chatId, 'Withdrawal amount must be greater than zero. Please try again.');
                            } else {
                                await sendMessage(chatId, 'Invalid amount or insufficient balance. Please try again.');
                            }
                            continue;
                        }

                        // Cancel pending requests if a new command is sent
                        if ((expectingReply || expectingWithdrawal || expectingReplyTo) && commandMap[text] !== undefined) {
                             userData[chatId].expectingReply = false;
                             userData[chatId].expectingWithdrawal = false;
                             userData[chatId].expectingReplyTo = null;
                             saveToLocalStorage();
                        }

                        // Check for promo codes
                        let isPromoCode = false;
                        for (const code in promoCodes) {
                            if (text === code) {
                                if (!userData[chatId].promosUsed.includes(code)) {
                                    userData[chatId].balance += promoCodes[code].bonus;
                                    userData[chatId].promosUsed.push(code);
                                    saveToLocalStorage();
                                    logLive('bot-reply', `User @${user.username || user.first_name} received promo bonus.`);
                                    await sendMessage(chatId, `🎉 Congratulations! You received a ${promoCodes[code].bonus} point bonus!`);
                                } else {
                                     await sendMessage(chatId, 'You have already used this promo code.');
                                }
                                isPromoCode = true;
                                break;
                            }
                        }
                        if (isPromoCode) continue;

                        let isRefCode = false;
                        for (const userId in userData) {
                            const refCodePlaceholder = userData[userId].refCode;
                            if (refCodePlaceholder && text.includes(refCodePlaceholder)) {
                                if (userId != chatId && !userData[chatId].referredBy) {
                                    userData[userId].refCount++;
                                    userData[chatId].referredBy = userId;
                                    
                                    const refBonusMatch = commandMap.refer.match(/\/refbonus:(\d+)\//);
                                    if (refBonusMatch) {
                                        const refBonus = parseInt(refBonusMatch[1], 10);
                                        userData[userId].balance += refBonus;
                                    }
                                    
                                    saveToLocalStorage();
                                    const referrerUsername = userData[userId].username ? `@${userData[userId].username}` : userData[userId].name;
                                    await sendMessage(chatId, `🎉 You were referred by ${referrerUsername}!`);
                                    await sendMessage(userId, `Congratulation you earn ${refBonusMatch[1]} for @${user.username}.`);
                                    isRefCode = true;
                                    break;
                                } else if (userData[chatId].referredBy) {
                                    const referrerUsername = userData[userData[chatId].referredBy].username ? `@${userData[userData[chatId].referredBy].username}` : userData[userData[chatId].referredBy].name;
                                    await sendMessage(chatId, `You have already been referred by ${referrerUsername}.`);
                                    isRefCode = true;
                                    break;
                                }
                            }
                        }
                        if (isRefCode) continue;

                        const reply = commandMap[text];
                        if (reply) {
                            commandsUsed++;
                            const parsedReply = parseReply(reply, update.message || update.callback_query.message);
                            await handleParsedReply(chatId, parsedReply);
                            if (parsedReply.refBonus > 0 && userData[chatId].referredBy) {
                                const referrerId = userData[chatId].referredBy;
                                if (userData[referrerId]) {
                                    userData[referrerId].balance += parsedReply.refBonus;
                                    saveToLocalStorage();
                                    await sendMessage(referrerId, `Congratulations! You earned ${parsedReply.refBonus} for @${user.username || user.first_name}.`);
                                }
                            }
                            
                            // Check for automatic referral bonus
                            if (userData[chatId] && userData[chatId].refCount === 1 && userData[chatId].balance === 0) {
                                const refBonusMatch = commandMap.refer.match(/\/refbonus:(\d+)\//);
                                if (refBonusMatch) {
                                    const refBonus = parseInt(refBonusMatch[1], 10);
                                    userData[chatId].balance += refBonus;
                                    saveToLocalStorage();
                                    await sendMessage(chatId, `Congratulations! You received a ${refBonus} point bonus for your first referral!`);
                                }
                            }
                        } else {
                            if (text.startsWith('/') && Object.keys(commandMap).some(cmd => text.startsWith(cmd))) {
                                // Ignore partial command matches
                            } else {
                                logLive('error', `Command not found: "${text}" from user ${chatId}`);
                                logError(`Command not found: "${text}" from user ${chatId}`);
                                await sendMessage(chatId, 'Sorry, I don\'t understand that command. Please use one from the menu.');
                            }
                        }
                    }
                } else {
                    logError(`Http error: ${data.description}`);
                    await sendError(data.description);
                    // Re-start polling after a brief delay on non-network errors.
                    setTimeout(() => { if (running) poll(); }, 2000);
                }
            } catch (e) {
                if (e instanceof TypeError && e.message === 'Failed to fetch') {
                    // Ignore "Failed to fetch" errors and continue polling
                    console.log('Network error, retrying...');
                    logLive('error', 'Network error, retrying...');
                } else {
                    logError(`Polling error: ${e.message}`);
                    await sendError(e.message);
                    stopBot();
                }
            }

            if(running) {
                setTimeout(poll, 1000);
            }
        }
        
        async function handleParsedReply(chatId, parsedReply) {
            if (userData[chatId] && userData[chatId].autodelete && messageHistory[chatId] && messageHistory[chatId].botMessageId) {
                await deleteMessage(chatId, messageHistory[chatId].botMessageId);
            }
            
            let botMessage = null;
            if (parsedReply.imageUrl) {
                botMessage = await sendImage(chatId, parsedReply.imageUrl, parsedReply.text, parsedReply.keyboard, 'HTML');
            } else {
                botMessage = await sendMessage(chatId, parsedReply.text, parsedReply.keyboard, 'HTML');
            }
            
            if (botMessage && parsedReply.autoDelete) {
                 messageHistory[chatId] = {
                    botMessageId: botMessage.result.message_id,
                 };
            }
            logLive('bot-reply', `Replied to user ${chatId} with: "${parsedReply.text.substring(0, 50)}..."`);
            saveToLocalStorage();
        }

        async function sendMessage(chatId, text, keyboard = null, parseMode = null) {
            try {
                let url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(text)}`;
                
                if (keyboard && Object.keys(keyboard).length > 0) {
                    url += `&reply_markup=${encodeURIComponent(JSON.stringify(keyboard))}`;
                }

                if (parseMode) {
                    url += `&parse_mode=${parseMode}`;
                }

                const res = await fetch(url);
                const data = await res.json();
                if (!data.ok) {
                    const isBlocked = data.description.includes('bot was blocked by the user');
                    if(isBlocked) {
                         blockedUsers[chatId] = true;
                         saveToLocalStorage();
                    }
                    logError(`Send message error: ${data.description}`);
                    await sendError(chatId, data.description);
                }
                return data;
            } catch (e) {
                logError(`Send message error: ${e.message}`);
                await sendError(chatId, e.message);
                return null;
            }
        }

        async function sendImage(chatId, imageUrl, caption = '', keyboard = null, parseMode = null) {
            try {
                let url = `https://api.telegram.org/bot${token}/sendPhoto?chat_id=${chatId}&photo=${encodeURIComponent(imageUrl)}&caption=${encodeURIComponent(caption)}`;

                if (keyboard && Object.keys(keyboard).length > 0) {
                    url += `&reply_markup=${encodeURIComponent(JSON.stringify(keyboard))}`;
                }

                if (parseMode) {
                    url += `&parse_mode=${parseMode}`;
                }
                
                const res = await fetch(url);
                const data = await res.json();
                if (!data.ok) {
                    const isBlocked = data.description.includes('bot was blocked by the user');
                    if(isBlocked) {
                         blockedUsers[chatId] = true;
                         saveToLocalStorage();
                    }
                    logError(`Send image error: ${data.description}`);
                    await sendError(chatId, data.description);
                }
                return data;
            } catch (e) {
                logError(`Send image error: ${e.message}`);
                await sendError(chatId, e.message);
                return null;
            }
        }
        
        async function deleteMessage(chatId, messageId) {
             try {
                if (!messageId) return;
                let url = `https://api.telegram.org/bot${token}/deleteMessage?chat_id=${chatId}&message_id=${messageId}`;
                const res = await fetch(url);
                const data = await res.json();
                if (!data.ok) {
                    logError(`Delete message error: ${data.description}`);
                }
            } catch (e) {
                logError(`Delete message error: ${e.message}`);
            }
        }

        async function sendError(chatId, errorText) {
            const errorMessage = `<b>Ally Bot command error 🐞:</b>\n\n<code>${errorText}</code>`;
            await fetch(`https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(errorMessage)}&parse_mode=HTML`);
        }

        function logError(msg) {
            errorLog.unshift({ time: new Date().toLocaleTimeString(), message: msg });
            if (errorLog.length > 50) {
                errorLog.pop();
            }
            saveToLocalStorage();
            if (document.getElementById('errors-btn').classList.contains('active')) {
                renderErrorLog();
            }
        }

        function updateLineNumbers() {
            const textarea = document.getElementById('edit-reply');
            const lineNumbersDiv = document.querySelector('.line-numbers');
            const lines = textarea.value.split('\n');
            let numbersHtml = '';
            for (let i = 1; i <= lines.length; i++) {
                numbersHtml += `<div>${i}</div>`;
            }
            lineNumbersDiv.innerHTML = numbersHtml;
            lineNumbersDiv.scrollTop = textarea.scrollTop;
        }

        function updatePlaceholderDisplay() {
            const replyText = document.getElementById('edit-reply');
            const displayDiv = document.getElementById('placeholder-display');
            
            const originalText = replyText.value;
            let highlightedHtml = '';
            let lastIndex = 0;
            
            const regex = /(\/\w+?\/|\/\w+?:.+?\/)/g;
            let match;
            
            while ((match = regex.exec(originalText)) !== null) {
                const preText = originalText.substring(lastIndex, match.index);
                highlightedHtml += preText;
                highlightedHtml += `<span class="placeholder-highlight">${match[0]}</span>`;
                lastIndex = regex.lastIndex;
            }
            
            highlightedHtml += originalText.substring(lastIndex);
            
            replyText.innerHTML = highlightedHtml.replace(/\n/g, '<br>');

            let matchedPlaceholders = [];
            PLACEHOLDERS.forEach(p => {
                if (originalText.includes(p.text)) {
                    matchedPlaceholders.push(p);
                }
            });

            if (matchedPlaceholders.length > 0) {
                let html = '<strong>In use:</strong> ';
                html += matchedPlaceholders.map(p => `<code>${p.text}</code>`).join(' ');
                displayDiv.innerHTML = html;
            } else {
                displayDiv.innerHTML = '';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('loading-screen').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 500); 
            }, 1500);

            loadFromLocalStorage();
            if(Object.keys(commandMap).length === 0) {
                commandMap['start'] = 'Hello /name/! I am your personal bot. Your current balance is /balance/ points. /autodelete/ /commandbtn:💸 Withdraw:withdraw//commandbtn:🤝 Refer & Earn:refer/';
                commandMap['withdraw'] = 'Your current balance is /balance/. Please enter the amount you want to withdraw. /autodelete/ /getwithdrawno/ /cancelbtn/';
                commandMap['refer'] = '🎉 Refer & Earn! Your referral code is /refbonus:10/. You have referred /refno/ users. /autodelete/';
                saveToLocalStorage();
            }
            showSection('home-section');

            const userSearch = document.getElementById('user-search');
            const textarea = document.getElementById('edit-reply');

            if (textarea) {
                textarea.addEventListener('input', () => {
                    updateLineNumbers();
                    updatePlaceholderDisplay();
                    const currentText = textarea.value;
                    if (undoStack[undoStack.length - 1] !== currentText) {
                        undoStack.push(currentText);
                        redoStack = []; 
                    }
                });
                textarea.addEventListener('scroll', () => {
                    document.querySelector('.line-numbers').scrollTop = textarea.scrollTop;
                });
            }

            if (userSearch) {
                userSearch.addEventListener('input', (e) => {
                    renderUserList(e.target.value);
                });
            }
        });
    </script>
</body>
</html>